<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Device Enrollment</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .container { max-width: 600px; margin: auto; }
    .error { color: red; margin-top: 20px; }
    .info { margin-top: 20px; }
    label { display: block; margin-top: 10px; }
    input[type="text"], input[type="email"] { width: 100%; padding: 8px; margin-top: 4px; }
    button { margin-top: 20px; padding: 10px 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Device Enrollment</h1>
    <div id="status">Loading user info...</div>

    <div id="user-info" style="display:none;">
      <p><strong>Full Name:</strong> <span id="fullname"></span></p>
      <p><strong>Assigned Stations:</strong> <span id="stations"></span></p>

      <form id="device-form">
        <label for="deviceName">Device Name:</label>
        <input type="text" id="deviceName" required>

        <label for="deviceId">Device ID:</label>
        <input type="text" id="deviceId" required>

        <button type="submit">Enroll Device</button>
      </form>

      <div id="form-status" class="error"></div>
    </div>

    <div id="error-message" class="error"></div>
  </div>

  <script>
    // 1. Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
      document.getElementById('status').style.display = 'none';
      document.getElementById('error-message').innerText = 'Missing token. Please use the link provided.';
    } else {
      // 2. Fetch user info from Workflow 3
      fetch("https://n8n.isychronsolutions.cloud/webhook-test/get-user-info", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('status').style.display = 'none';
        if (data.success) {
          document.getElementById('user-info').style.display = 'block';
          document.getElementById('fullname').innerText = data.fullname;
          document.getElementById('stations').innerText = data.assigned_stations;
        } else {
          document.getElementById('error-message').innerText = data.message;
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById('status').style.display = 'none';
        document.getElementById('error-message').innerText = 'Unable to fetch user info. Please try again later.';
      });
    }

    // 3. Handle device form submission
    document.getElementById('device-form')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const deviceName = document.getElementById('deviceName').value.trim();
      const deviceId = document.getElementById('deviceId').value.trim();
      const formStatus = document.getElementById('form-status');

      if (!deviceName || !deviceId) {
        formStatus.innerText = 'Please fill in both device name and device ID.';
        return;
      }

      // POST device info to device enrollment webhook (Workflow B)
      fetch("https://n8n.isychronsolutions.cloud/webhook-test/device-enroll", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, deviceName, deviceId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          formStatus.style.color = 'green';
          formStatus.innerText = 'Device enrolled successfully!';
          document.getElementById('device-form').reset();
        } else {
          formStatus.style.color = 'red';
          formStatus.innerText = data.message || 'Device enrollment failed.';
        }
      })
      .catch(err => {
        console.error(err);
        formStatus.style.color = 'red';
        formStatus.innerText = 'Error enrolling device. Please try again.';
      });
    });
  </script>
</body>
</html>
