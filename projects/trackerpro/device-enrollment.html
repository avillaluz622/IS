<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Management</title>
    <style>
        :root { --primary: #0071e3; --bg: #f5f5f7; --text: #1d1d1f; --card-bg: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; -webkit-font-smoothing: antialiased; }
        
        .container { width: 100%; max-width: 480px; }
        
        /* Profile Header Styles */
        .header-card { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 34px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 8px; }
        .badge { background: #e8e8ed; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; color: #515154; text-transform: uppercase; letter-spacing: 0.5px; }
        .station-info { font-size: 15px; color: #86868b; margin-top: 12px; }

        /* Enrollment Form Section */
        .enroll-section { background: var(--card-bg); padding: 24px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); margin-bottom: 32px; }
        .input-group { display: flex; gap: 12px; }
        input { flex: 1; padding: 12px 16px; border: 1px solid #d2d2d7; border-radius: 12px; font-size: 16px; background: #fafafa; outline: none; transition: border 0.2s ease; }
        input:focus { border-color: var(--primary); background: #fff; }
        
        button#enrollBtn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s ease; min-width: 80px; }
        button#enrollBtn:disabled { background: #d2d2d7; cursor: not-allowed; opacity: 0.7; }
        
        /* Device List Styles */
        .device-item { background: var(--card-bg); padding: 18px 24px; border-radius: 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 12px rgba(0,0,0,0.03); transition: transform 0.2s ease; }
        .device-item:hover { transform: translateY(-2px); }
        .device-info { display: flex; flex-direction: column; }
        .device-name { font-weight: 600; font-size: 17px; margin-bottom: 2px; }
        .device-id { font-size: 13px; color: #86868b; font-family: monospace; }
        
        .btn-delete { color: #ff3b30; background: none; border: none; font-size: 14px; font-weight: 500; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s ease; }
        .btn-delete:hover { background: #fff5f5; }

        .empty-state { text-align: center; color: #86868b; margin-top: 40px; font-size: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card" id="profileHeader">
        <h1>Welcome</h1>
        <p>Loading your profile...</p>
    </div>

    <div class="enroll-section">
        <div class="input-group">
            <input type="text" id="deviceName" placeholder="Enter device name" autocomplete="off">
            <button id="enrollBtn">Add</button>
        </div>
    </div>

    <div id="deviceList">
        </div>
</div>

<script>
    // Production Webhook URL
    const WEBHOOK_URL = "https://n8n.isychronsolutions.cloud/webhook/auth-check";
    // const WEBHOOK_URL = "https://n8n.isychronsolutions.cloud/webhook-test/auth-check";
    
    const params = new URLSearchParams(window.location.search);
    const user_id = params.get('user_id');

    async function loadData() {
        if (!user_id) return;
        
        try {
            const resp = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: "fetch_enrollment_data", user_id: user_id })
            });
            const data = await resp.json();
            
            // Render Header with role and station (singular)
            document.getElementById('profileHeader').innerHTML = `
                <h1>${data.fullname || 'Welcome'}</h1>
                <span class="badge">${data.role || 'User'}</span>
                <div class="station-info">Station: ${data.assigned_station || 'Not Assigned'}</div>
            `;

            // Render Device List
            const listEl = document.getElementById('deviceList');
            if (data.devices && data.devices.length > 0) {
                listEl.innerHTML = data.devices.map(d => `
                    <div class="device-item">
                        <div class="device-info">
                            <span class="device-name">${d.device_name}</span>
                            <span class="device-id">${d.device_id}</span>
                        </div>
                        <button class="btn-delete" onclick="deleteDevice('${d.device_id}')">Remove</button>
                    </div>
                `).join('');
            } else {
                listEl.innerHTML = '<div class="empty-state">No devices enrolled yet.</div>';
            }
        } catch (err) {
            console.error("Error loading data:", err);
        }
    }

    // Enrollment logic with auto-refresh and disabled state
    document.getElementById('enrollBtn').onclick = async function() {
        const input = document.getElementById('deviceName');
        const btn = this;
        const deviceName = input.value.trim();

        if (!deviceName) return;

        // Disable UI during submission
        btn.disabled = true;
        btn.innerText = "Adding...";
        input.disabled = true;

        try {
            const resp = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    action: "enroll_device", 
                    user_id: user_id, 
                    device_name: deviceName 
                })
            });
            
            const res = await resp.json();

            if (res.success) {
                input.value = ''; // Clear field
                await loadData(); // Refresh list
            } else {
                alert("Error: " + (res.message || "Could not enroll device"));
            }
        } catch (err) {
            alert("Connection error. Please try again.");
        } finally {
            // Restore UI state
            btn.disabled = false;
            btn.innerText = "Add";
            input.disabled = false;
            input.focus();
        }
    };

    async function deleteDevice(id) {
        if (!confirm("Are you sure you want to remove this device?")) return;
        
        try {
            await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: "delete_device", device_id: id })
            });
            loadData(); // Refresh list after deletion
        } catch (err) {
            alert("Failed to remove device.");
        }
    }

    // Initial data fetch
    if (user_id) {
        loadData();
    } else {
        document.getElementById('profileHeader').innerHTML = "<h1>Access Denied</h1><p>No user ID found.</p>";
    }
</script>

</body>
</html>
