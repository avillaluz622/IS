<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Device Management</title>
    <style>
        :root { --primary: #0071e3; --bg: #f5f5f7; --text: #1d1d1f; --card-bg: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .container { width: 100%; max-width: 480px; }
        
        /* Header Section */
        .header-card { text-align: center; margin: 30px 0; }
        h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.5px; }
        .badge { background: #e8e8ed; padding: 5px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #515154; text-transform: uppercase; }
        .station-info { font-size: 15px; color: #86868b; margin-top: 10px; }

        /* Enrollment Section */
        .enroll-section { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); margin-bottom: 25px; }
        .input-group { display: flex; flex-direction: column; gap: 12px; }
        input { width: 100%; height: 50px; padding: 0 16px; border: 1px solid #d2d2d7; border-radius: 12px; font-size: 16px; background: #fafafa; outline: none; transition: border 0.2s; }
        input:focus { border-color: var(--primary); background: #fff; }
        
        button#enrollBtn { height: 50px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; transition: opacity 0.2s; }
        button#enrollBtn:disabled { background: #d2d2d7; opacity: 0.7; }
        
        /* Device List Section */
        .device-item { background: var(--card-bg); padding: 18px; border-radius: 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 12px rgba(0,0,0,0.03); }
        .device-info { display: flex; flex-direction: column; flex: 1; padding-right: 10px; }
        .device-name { font-weight: 600; font-size: 16px; margin-bottom: 2px; color: var(--text); }
        .device-alias { font-weight: 400; font-size: 13px; margin-left: 4px; color: #86868b; }
        .device-id { font-size: 12px; color: #86868b; font-family: monospace; }
        
        .btn-delete { color: #ff3b30; background: none; border: none; font-size: 14px; font-weight: 600; cursor: pointer; padding: 10px; white-space: nowrap; }

        /* Toast Notification System */
        .toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(29, 29, 31, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card" id="profileHeader">
        <h1>Welcome</h1>
        <p>Loading your profile...</p>
    </div>

    <div class="enroll-section">
        <div class="input-group">
            <input type="text" id="deviceName" placeholder="New device name" autocomplete="off" inputmode="text">
            <button id="enrollBtn">Add Device</button>
        </div>
    </div>

    <div id="deviceList">
        </div>
</div>

<div id="toast" class="toast">Action Successful</div>

<script>
    //const WEBHOOK_URL = "https://n8n.isychronsolutions.cloud/webhook/auth-check";
    const WEBHOOK_URL = "https://n8n.isychronsolutions.cloud/webhook-test/auth-check";
    const params = new URLSearchParams(window.location.search);
    const user_id = params.get('user_id');

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    async function loadData() {
        if (!user_id) return;
        
        try {
            const resp = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: "fetch_enrollment_data", user_id: user_id })
            });
            const data = await resp.json();
            
            // Render Header
            document.getElementById('profileHeader').innerHTML = `
                <h1>${data.fullname || 'Welcome'}</h1>
                <span class="badge">${data.role || 'User'}</span>
                <div class="station-info">Station: ${data.assigned_station || 'Unassigned'}</div>
            `;

            // Render Device List with Name and Alias
            const listEl = document.getElementById('deviceList');
            if (data.devices && data.devices.length > 0) {
                listEl.innerHTML = data.devices.map(d => `
                    <div class="device-item">
                        <div class="device-info">
                            <span class="device-name">${d.device_name} (${d.device_alias || 'No Alias'})</span>
                            <span class="device-id">ID: ${d.device_id}</span>
                        </div>
                        <button class="btn-delete" onclick="deleteDevice('${d.device_id}')">Remove</button>
                    </div>
                `).join('');
            } else {
                listEl.innerHTML = '<p style="text-align:center; color:#86868b; margin-top:40px;">No devices yet.</p>';
            }
        } catch (err) {
            console.error("Load error:", err);
        }
    }

    document.getElementById('enrollBtn').onclick = async function() {
        const input = document.getElementById('deviceName');
        const btn = this;
        const deviceName = input.value.trim();

        if (!deviceName) return;

        btn.disabled = true;
        btn.innerText = "Adding...";

        try {
            const resp = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    action: "enroll_device", 
                    user_id: user_id, 
                    device_name: deviceName 
                })
            });
            
            if (resp.ok) {
                input.value = '';
                showToast("Device enrolled");
                setTimeout(() => { window.location.reload(); }, 800); 
            }
        } catch (err) {
            alert("Success! Refreshing...");
            window.location.reload();
        } finally {
            btn.disabled = false;
            btn.innerText = "Add Device";
        }
    };

    async function deleteDevice(id) {
        if (!confirm("Are you sure you want to remove this device?")) return;
        
        showToast("Removing...");
        try {
            const resp = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: "delete_device", device_id: id })
            });

            if (resp.ok) {
                showToast("Device removed");
                setTimeout(() => { window.location.reload(); }, 800);
            }
        } catch (err) {
            window.location.reload();
        }
    }

    if (user_id) {
        loadData();
    } else {
        document.getElementById('profileHeader').innerHTML = "<h1>Access Denied</h1>";
    }
</script>

</body>
</html>
