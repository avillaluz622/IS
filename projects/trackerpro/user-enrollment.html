<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Enrollment</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f6f8; display: flex; flex-direction: column; align-items: center; padding: 40px 20px; }
  .info-box, .form-box { background: #fff; padding: 20px 30px; margin: 15px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 400px; width: 100%; text-align: center; }
  label { display: block; margin: 12px 0 5px; font-weight: bold; color: #555; }
  input[type="password"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
  button { margin-top: 20px; padding: 12px 25px; background-color: #0077ff; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
  .message { margin-top: 15px; color: red; font-size: 14px; }
</style>
</head>
<body>

<h1>User Enrollment</h1>

<div class="info-box" id="user-info">
  <p><strong>Full Name:</strong> <span id="fullname">Loading...</span></p>
  <p><strong>Email:</strong> <span id="email">Loading...</span></p>
  <p><strong>Assigned Stations:</strong> <span id="assigned-stations">Loading...</span></p>
</div>

<div class="form-box" id="password-box" style="display: none;"> <form id="reset-form">
    <label for="password">Set your new password:</label>
    <input type="password" id="password" name="new-password" placeholder="Enter new password" required>
    <button type="submit" id="submit-btn">Reset Password</button>
    <div class="message" id="msg"></div>
  </form>
</div>

<script>
const RESET_PASSWORD_URL = "https://n8n.isychronsolutions.cloud/webhook-test/password-reset";
const GET_USER_URL = "https://n8n.isychronsolutions.cloud/webhook-test/get-user-info";

const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get("token");

const fullnameEl = document.getElementById("fullname");
const emailEl = document.getElementById("email");
const stationsEl = document.getElementById("assigned-stations");
const msgEl = document.getElementById("msg");
const passwordBox = document.getElementById("password-box");

if (!token) {
    msgEl.textContent = "Error: No security token found in URL.";
    msgEl.parentElement.style.display = "block";
} else {
    fetch(GET_USER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: token })
    })
    .then(async resp => {
        if (!resp.ok) throw new Error(`Server Error: ${resp.status}`);
        return resp.json();
    })
    .then(data => {
        // Handle n8n returning an array (common in n8n)
        const user = Array.isArray(data) ? data[0] : data;

        if (!user || !user.user_id) {
            throw new Error("User data not found or token expired.");
        }

        fullnameEl.textContent = user.fullname || "N/A";
        emailEl.textContent = user.email || "N/A";
        stationsEl.textContent = user.assigned_stations || "None";

        // Logic check: if already reset, redirect
        if (user.password_reset_at) {
            msgEl.style.color = "green";
            msgEl.textContent = "Account already active. Redirecting...";
            setTimeout(() => {
                window.location.href = `device-enrollment.html?user_id=${user.user_id}`;
            }, 1500);
        } else {
            passwordBox.style.display = "block";
        }
    })
    .catch(err => {
        console.error("Fetch error:", err);
        fullnameEl.textContent = "Error";
        emailEl.textContent = "Error";
        stationsEl.textContent = "Error";
        msgEl.textContent = "Connection failed: Check CORS or n8n status.";
        passwordBox.style.display = "none";
    });
}

// Submit Logic
document.getElementById("reset-form").addEventListener("submit", (e) => {
    e.preventDefault();
    const newPassword = document.getElementById("password").value;
    
    fetch(RESET_PASSWORD_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: token, password: newPassword })
    })
    .then(resp => resp.json())
    .then(data => {
        msgEl.style.color = "green";
        msgEl.textContent = "Success! Redirecting...";
        // ... (your redirect logic)
    })
    .catch(err => {
        msgEl.textContent = "Submit failed. Try again.";
    });
});
</script>
</body>
</html>
