<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Enrollment</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f6f8; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; padding: 40px 20px; }
  h1 { color: #333; text-align: center; }
  .info-box, .form-box { background: #fff; padding: 20px 30px; margin: 15px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 400px; width: 100%; text-align: center; }
  label { display: block; margin: 12px 0 5px; font-weight: bold; color: #555; }
  input[type="password"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
  button { margin-top: 20px; padding: 12px 25px; background-color: #0077ff; color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
  button:hover { background-color: #005fcc; }
  .message { margin-top: 15px; color: red; font-weight: bold; }
</style>
</head>
<body>

<h1>User Enrollment</h1>

<div class="info-box" id="user-info">
  <p><strong>Full Name:</strong> <span id="fullname">Loading...</span></p>
  <p><strong>Email:</strong> <span id="email">Loading...</span></p>
  <p><strong>Assigned Stations:</strong> <span id="assigned-stations">Loading...</span></p>
</div>

<div class="form-box" id="password-box" style="display: none;">
  <form id="reset-form">
    <label for="password_input">Set your new password:</label>
    <input type="password" id="password_input" name="password" placeholder="Enter new password" required>
    <button type="submit">Reset Password</button>
    <div class="message" id="msg"></div>
  </form>
</div>

<script>
// === CONFIGURATION ===
// Switch these to the "Production URL" (no -test) once your workflow is Active!
const GET_USER_URL = "https://n8n.isychronsolutions.cloud/webhook-test/get-user-info";
const RESET_PASSWORD_URL = "https://n8n.isychronsolutions.cloud/webhook-test/password-reset";

const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get("token");

const fullnameEl = document.getElementById("fullname");
const emailEl = document.getElementById("email");
const stationsEl = document.getElementById("assigned-stations");
const msgEl = document.getElementById("msg");
const passwordBox = document.getElementById("password-box");

if (!token) {
    fullnameEl.textContent = "Error";
    msgEl.textContent = "Missing token. Check your link.";
} else {
    fetch(GET_USER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: token })
    })
    .then(response => {
        if (!response.ok) throw new Error("Server communication failed.");
        return response.json();
    })
    .then(data => {
        // FIX: Handle n8n sending an array instead of a single object
        const user = Array.isArray(data) ? data[0] : data;

        if (!user || !user.user_id) {
            throw new Error("User data not found.");
        }

        // Display Data
        fullnameEl.textContent = user.fullname || "N/A";
        emailEl.textContent = user.email || "N/A";
        stationsEl.textContent = user.assigned_stations || "N/A";

        // Logic check: only show box if password isn't set
        if (user.password_reset_at) {
            msgEl.style.color = "green";
            msgEl.textContent = "Redirecting to enrollment...";
            // Optional: window.location.href = 'device-enrollment.html';
        } else {
            passwordBox.style.display = "block";
        }
    })
    .catch(err => {
        console.error("Initialization Error:", err);
        fullnameEl.textContent = "Error";
        emailEl.textContent = "Error";
        stationsEl.textContent = "Error";
        msgEl.textContent = "Could not load user data. Contact Support.";
    });
}

document.getElementById("reset-form").addEventListener("submit", (e) => {
    e.preventDefault();
    const newPassword = document.getElementById("password_input").value;

    fetch(RESET_PASSWORD_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: token, password: newPassword })
    })
    .then(resp => resp.json())
    .then(data => {
        msgEl.style.color = "green";
        msgEl.textContent = "Password set! Redirecting...";
        // Redirect logic here
    })
    .catch(err => {
        msgEl.style.color = "red";
        msgEl.textContent = "Update failed. Try again.";
    });
});
</script>

</body>
</html>
